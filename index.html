<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medical Q&A — Education Only</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;max-width:760px;margin:40px auto;padding:0 16px;line-height:1.45}
    h1{margin-bottom:6px}
    .disclaimer{background:#fff3cd;border:1px solid #ffe69c;padding:10px 12px;border-radius:10px;margin:8px 0 16px}
    .chat{border:1px solid #eee;border-radius:12px;padding:12px;margin:12px 0;max-height:420px;overflow:auto}
    .msg{margin:8px 0;padding:10px 12px;border-radius:12px;max-width:85%}
    .me{background:#eef6ff;margin-left:auto}
    .bot{background:#f7f7f7}
    textarea{width:100%;min-height:90px;padding:10px;border-radius:10px;border:1px solid #ddd}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;cursor:pointer}
    .card{border:1px solid #eee;border-radius:12px;padding:12px;margin-top:14px}
    .muted{opacity:.8;font-size:.92em}
    .hidden{display:none}
    .chip{font-size:.85em;border:1px solid #ddd;border-radius:999px;padding:5px 9px}
    details summary{cursor:pointer}

    /* typing indicator */
    .typing{display:flex;align-items:center;gap:6px;margin:6px 0}
    .typing.hidden{display:none}
    .dot{width:6px;height:6px;border-radius:50%;background:#bbb;animation:blink 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
  </style>
</head>
<body>
  <h1>Medical Q&amp;A <span class="muted">— general education only</span></h1>

  <div class="disclaimer">
    <strong>Important:</strong> This bot was developed and instructed by <strong>Doc Adam</strong> for
    <em>general education only</em>. It <strong>can make mistakes</strong>. It’s not medical advice,
    diagnosis, or a treatment plan. Huwag maglagay ng personal data (pangalan, address, birthday, photos).
    If symptoms are new, severe, or worsening, please see a doctor or go to ED.
  </div>

  <!-- Chat log -->
  <div id="chat" class="chat"></div>

  <!-- typing indicator -->
  <div id="typing" class="typing hidden">
    <span class="muted">Assistant is typing</span>
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>

  <form id="qform">
    <label for="q" class="muted">Type your question or follow-up:</label>
    <textarea id="q" placeholder="e.g., Headache for 2 days, worse at night — what should I check?" required minlength="5" maxlength="800"></textarea>
    <div class="row">
      <button type="submit" id="askBtn">Send</button>
      <button type="button" id="newBtn" class="chip">New topic</button>
      <span id="turns" class="muted"></span>
    </div>
  </form>

  <!-- Advice panel (rendered only when stage === 'advice') -->
  <div id="result" class="card hidden">
    <details id="detailsBox">
      <summary><strong>Show details</strong> <span class="muted">(causes, treatments, tests, self-care, urgent signs)</span></summary>

      <div id="disc" class="muted" style="margin-top:8px"></div>

      <h3 style="margin:8px 0 6px">Summary</h3>
      <div id="summary"></div>

      <h3 style="margin:8px 0 6px">Possible causes</h3>
      <ul id="causes"></ul>

      <h3 style="margin:8px 0 6px">Typical treatments (doctor-directed)</h3>
      <ul id="treatments"></ul>

      <h3 style="margin:8px 0 6px">Common investigations</h3>
      <ul id="investigations"></ul>

      <h3 style="margin:8px 0 6px">Safe self-care options</h3>
      <ul id="selfcare"></ul>

      <h3 style="margin:8px 0 6px">Urgent-care triggers</h3>
      <ul id="urgent"></ul>

      <h3 style="margin:8px 0 6px">Final reminder</h3>
      <div id="final"></div>

      <details style="margin-top:8px" id="refsWrap" class="hidden">
        <summary>References</summary>
        <ul id="refs"></ul>
      </details>
    </details>
  </div>

  <script>
    const chatEl   = document.getElementById("chat");
    const form     = document.getElementById("qform");
    const btn      = document.getElementById("askBtn");
    const newBtn   = document.getElementById("newBtn");
    const turnsEl  = document.getElementById("turns");
    const typingEl = document.getElementById("typing");
    const ui = {
      result: document.getElementById("result"),
      detailsBox: document.getElementById("detailsBox"),
      disc: document.getElementById("disc"),
      summary: document.getElementById("summary"),
      causes: document.getElementById("causes"),
      treatments: document.getElementById("treatments"),
      investigations: document.getElementById("investigations"),
      selfcare: document.getElementById("selfcare"),
      urgent: document.getElementById("urgent"),
      final: document.getElementById("final"),
      refsWrap: document.getElementById("refsWrap"),
      refs: document.getElementById("refs"),
    };

    // ---- conversation history (saved locally for follow-ups) ----
    let history = [];
    try {
      const saved = JSON.parse(localStorage.getItem("medqa_history") || "[]");
      if (Array.isArray(saved)) history = saved.slice(-12);
    } catch {}
    updateTurns();

    function updateTurns(){
      turnsEl.textContent = history.length ? `Context turns: ${history.length}` : "";
    }
    function saveHistory(){
      try { localStorage.setItem("medqa_history", JSON.stringify(history.slice(-12))); } catch {}
      updateTurns();
    }

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = `msg ${role === "user" ? "me" : "bot"}`;
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function listify(arr){
      if (!Array.isArray(arr) || !arr.length) return "<li>—</li>";
      return arr.map(x => `<li>${escapeHtml(String(x))}</li>`).join("");
    }
    function escapeHtml(s){
      return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    newBtn.addEventListener("click", () => {
      history = [];
      saveHistory();
      chatEl.innerHTML = "";
      ui.result.classList.add("hidden");
      ui.detailsBox.open = false;
      typingEl.classList.add("hidden");
      document.getElementById("q").focus();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = document.getElementById("q").value.trim();
      if (!question) return;
      addMsg("user", question);
      document.getElementById("q").value = "";
      btn.disabled = true; btn.textContent = "Thinking…";
      typingEl.classList.remove("hidden");

      try {
        const r = await fetch("/.netlify/functions/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, history })
        });
        const j = await r.json();
        if (!j.ok) throw j;

        const o = j.result || {};
        const stage = o.stage || (Array.isArray(o.possible_causes) ? "advice" : "intake");

        // Always show the conversational bit (short)
        const chatReply = o.chat_reply || "";
        const askBack = o.ask_back ? `\n\n${o.ask_back}` : "";
        addMsg("assistant", chatReply + askBack);

        // Save turn in short form
        history.push({ role: "user", content: question });
        history.push({ role: "assistant", content: (chatReply + askBack).slice(0,800) });
        history = history.slice(-12);
        saveHistory();

        // Render advice panel only during advice stage
        if (stage === "advice") {
          ui.disc.textContent = o.disclaimer || "General education only — not medical advice.";
          ui.summary.textContent = o.summary || "";
          ui.causes.innerHTML = listify(o.possible_causes || []);
          ui.treatments.innerHTML = listify(o.typical_treatments || []);
          ui.investigations.innerHTML = listify(o.common_investigations || []);
          ui.selfcare.innerHTML = listify(o.self_care || []);
          // back-compat for older names:
          const urgent = o.urgent_triggers || o.red_flags || [];
          ui.urgent.innerHTML = listify(urgent);
          ui.final.textContent = o.final_reminder || (o.when_to_seek_help || "");
          if (Array.isArray(o.references) && o.references.length) {
            ui.refsWrap.classList.remove("hidden");
            ui.refs.innerHTML = o.references.map(r => `<li>${escapeHtml(String(r))}</li>`).join("");
          } else {
            ui.refsWrap.classList.add("hidden");
            ui.refs.innerHTML = "";
          }
          ui.result.classList.remove("hidden");
          // keep details collapsed by default
          ui.detailsBox.open = false;
        } else {
          // Intake stage: hide details
          ui.result.classList.add("hidden");
          ui.detailsBox.open = false;
        }

      } catch (err) {
        const msg = err?.error?.message || err?.error || err?.message || "Something went wrong. Try again.";
        alert(msg);
      } finally {
        btn.disabled = false; btn.textContent = "Send";
        typingEl.classList.add("hidden");
      }
    });
  </script>
</body>
</html>
