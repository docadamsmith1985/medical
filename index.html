<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medical Q&A — Education Only</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;max-width:760px;margin:40px auto;padding:0 16px;line-height:1.45}
    h1{margin-bottom:6px}
    .disclaimer{background:#fff3cd;border:1px solid #ffe69c;padding:10px 12px;border-radius:10px;margin:8px 0 16px}
    textarea{width:100%;min-height:120px;padding:10px;border-radius:10px;border:1px solid #ddd}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .card{border:1px solid #eee;border-radius:12px;padding:12px;margin-top:14px}
    .muted{opacity:.8;font-size:.92em}
    .hidden{display:none}
    .chip{font-size:.85em;border:1px solid #ddd;border-radius:999px;padding:5px 9px}
  </style>
</head>
<body>
  <h1>Medical Q&amp;A <span class="muted">— general education only</span></h1>
  <div class="disclaimer"><strong>Important:</strong> This is <em>not</em> medical advice. Huwag maglagay ng personal data (pangalan, address, birthday, photos). If you have new, severe, or worsening symptoms, see a doctor or go to ED.</div>

  <form id="qform">
    <label for="q" class="muted">Your question (no personal info):</label>
    <textarea id="q" placeholder="e.g., 'Bakit namamaga at masakit ang big toe ko?'" required minlength="10" maxlength="800"></textarea>
    <div class="row">
      <button type="submit" id="askBtn">Ask</button>
      <button type="button" id="newBtn" class="chip">New topic</button>
      <span id="turns" class="muted"></span>
    </div>
  </form>

  <div id="result" class="card hidden">
    <div id="disc" class="muted"></div>
    <h3 style="margin:8px 0 6px">Answer</h3>
    <div id="edu"></div>
    <h4 style="margin:10px 0 6px">Red flags</h4>
    <ul id="flags"></ul>
    <h4 style="margin:10px 0 6px">When to seek help</h4>
    <div id="seek"></div>
    <details style="margin-top:8px" id="refsWrap" class="hidden">
      <summary>References</summary>
      <ul id="refs"></ul>
    </details>
  </div>

  <script>
    const form = document.getElementById("qform");
    const btn = document.getElementById("askBtn");
    const newBtn = document.getElementById("newBtn");
    const turnsEl = document.getElementById("turns");
    const ui = {
      result: document.getElementById("result"),
      disc: document.getElementById("disc"),
      edu: document.getElementById("edu"),
      flags: document.getElementById("flags"),
      seek: document.getElementById("seek"),
      refsWrap: document.getElementById("refsWrap"),
      refs: document.getElementById("refs"),
    };

    // ---- conversation history (kept in memory + localStorage) ----
    let history = [];
    try {
      const saved = JSON.parse(localStorage.getItem("medqa_history") || "[]");
      if (Array.isArray(saved)) history = saved.slice(-12);
    } catch {}

    function saveHistory() {
      try { localStorage.setItem("medqa_history", JSON.stringify(history.slice(-12))); } catch {}
      turnsEl.textContent = history.length ? `Context turns: ${history.length}` : "";
    }
    saveHistory();

    newBtn.addEventListener("click", () => {
      history = [];
      saveHistory();
      ui.result.classList.add("hidden");
      document.getElementById("q").value = "";
      document.getElementById("q").focus();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = document.getElementById("q").value.trim();
      ui.result.classList.add("hidden");
      btn.disabled = true; btn.textContent = "Thinking…";

      try {
        const r = await fetch("/.netlify/functions/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, history })
        });
        const j = await r.json();
        if (!j.ok) throw j;

        const { disclaimer, edu_answer, red_flags, when_to_seek_help, references } = j.result;
        ui.disc.textContent = disclaimer || "General education only.";
        ui.edu.textContent = edu_answer || "";
        ui.flags.innerHTML = (red_flags || []).map(f => `<li>${f}</li>`).join("");
        ui.seek.textContent = when_to_seek_help || "";

        if (Array.isArray(references) && references.length) {
          ui.refsWrap.classList.remove("hidden");
          ui.refs.innerHTML = references.map(r => `<li>${r}</li>`).join("");
        } else {
          ui.refsWrap.classList.add("hidden");
          ui.refs.innerHTML = "";
        }
        ui.result.classList.remove("hidden");

        // ---- add this Q/A to history so follow-ups carry context ----
        history.push({ role: "user", content: question });
        const assistantSummary = [
          edu_answer || "",
          red_flags?.length ? `Red flags: ${red_flags.join("; ")}` : "",
          when_to_seek_help ? `When to seek help: ${when_to_seek_help}` : ""
        ].filter(Boolean).join("\n");
        history.push({ role: "assistant", content: assistantSummary.slice(0, 800) });
        history = history.slice(-12);
        saveHistory();

      } catch (err) {
        const msg =
          err?.error?.message ||
          err?.error ||
          err?.message ||
          JSON.stringify(err) ||
          "Something went wrong. Try again.";
        alert(msg);
      } finally {
        btn.disabled = false; btn.textContent = "Ask";
      }
    });
  </script>
</body>
</html>
