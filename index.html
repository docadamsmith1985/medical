<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medical Q&A — general education only</title>
  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#666; --panel:#f7f7f7;
      --accent:#fff3cd; --accent-border:#ffe69c;
      --me:#eef6ff; --bot:#f5f5f5; --border:#e6e6e6;
    }
    html,body{background:var(--bg); color:var(--fg)}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
         max-width:760px;margin:40px auto;padding:0 16px;line-height:1.45}
    h1{margin:0 0 10px 0}
    .muted{color:var(--muted)}
    .disclaimer{background:var(--accent);border:1px solid var(--accent-border);
                padding:12px 14px;border-radius:12px;margin:12px 0 16px}
    .chat{border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0;
          max-height:520px;overflow:auto;background:#fff}
    .msg{margin:8px 0;padding:10px 12px;border-radius:12px;max-width:85%;
         white-space:pre-wrap}
    .me{background:var(--me);margin-left:auto}
    .bot{background:var(--bot)}
    textarea{width:100%;min-height:90px;padding:10px;border-radius:10px;border:1px solid var(--border);
             font:inherit}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#fff}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .chip{font-size:.85em;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .typing{display:flex;align-items:center;gap:6px;margin:6px 0 0 2px}
    .typing.hidden{display:none}
    .dot{width:6px;height:6px;border-radius:50%;background:#bbb;animation:blink 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.25}40%{opacity:1}}
  </style>
</head>
<body>
  <h1>Medical Q&amp;A <span class="muted">— general education only</span></h1>

  <div class="disclaimer">
    <strong>Important:</strong> This bot was developed and instructed by <strong>Doc Adam</strong> for
    <em>general education only</em>. It <strong>can make mistakes</strong> and is <strong>not a medical service</strong>.
    It doesn’t give diagnoses or treatment plans and can’t consider your full medical history.
    <strong>Don’t start/stop medicines</strong> based on this. If symptoms are <strong>new, severe, or worsening</strong>,
    please see a doctor or go to ED.
  </div>

  <!-- Chat log -->
  <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

  <!-- typing indicator -->
  <div id="typing" class="typing hidden" aria-hidden="true">
    <span class="muted">Assistant is typing</span>
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>

  <form id="qform" autocomplete="off">
    <label for="q" class="muted">Type your question or follow-up:</label>
    <textarea id="q" placeholder="e.g., Headache for 2 days, worse at night — what should I check?"></textarea>
    <div class="row">
      <button type="submit" id="askBtn">Send</button>
      <button type="button" id="newBtn" class="chip" title="Clear conversation">New topic</button>
      <span id="turns" class="muted" style="margin-left:auto"></span>
    </div>
    <div class="muted" style="font-size:.85em;margin-top:6px">
      Tip: <kbd>Enter</kbd> to send, <kbd>Shift</kbd>+<kbd>Enter</kbd> for a new line.
    </div>
  </form>

  <script>
    // UI elements
    const chatEl   = document.getElementById("chat");
    const form     = document.getElementById("qform");
    const btn      = document.getElementById("askBtn");
    const newBtn   = document.getElementById("newBtn");
    const turnsEl  = document.getElementById("turns");
    const typingEl = document.getElementById("typing");
    const inputEl  = document.getElementById("q");

    // ---- conversation history (saved locally for follow-ups) ----
    let history = [];
    try {
      const saved = JSON.parse(localStorage.getItem("medqa_history") || "[]");
      if (Array.isArray(saved)) history = saved.slice(-12);
    } catch {}
    updateTurns();

    function updateTurns(){
      const n = history.length;
      turnsEl.textContent = n ? `Context turns: ${n}` : "";
    }
    function saveHistory(){
      try { localStorage.setItem("medqa_history", JSON.stringify(history.slice(-12))); } catch {}
      updateTurns();
    }

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = `msg ${role === "user" ? "me" : "bot"}`;
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Build a readable advice bubble from the structured response
    function formatAdvice(o){
      const infoGaps = Array.isArray(o.info_gaps) ? o.info_gaps.slice(0,3) : [];
      const disc = o.disclaimer || "I can’t give a specific diagnosis or treatment for you. This is general education only. I can share possibilities and ideas to discuss with your doctor.";
      const watch = Array.isArray(o.urgent_triggers) ? o.urgent_triggers.slice(0,5) : [];

      // Prefer model-composed teach-back
      if (o.advice_text && o.advice_text.trim()) {
        const extra = [];
        if (infoGaps.length) extra.push(`\n\nInfo your doctor may ask/check:\n- ${infoGaps.join("\n- ")}`);
        if (watch.length && !o.advice_text.toLowerCase().includes("watch-outs")) {
          extra.push(`\n\nWatch-outs:\n- ${watch.join("\n- ")}`);
        }
        return `${disc}\n\n${o.advice_text.trim()}${extra.join("")}`;
      }

      // Fallback builder
      const bullet = (label, arr) => (Array.isArray(arr) && arr.length)
        ? `${label}\n- ${arr.map(x => String(x)).join("\n- ")}` : "";
      const parts = [
        disc,
        o.summary ? `What I think so far — ${o.summary}` : "",
        bullet("What it could be (in general)", (o.possible_causes||[]).slice(0,3)),
        bullet("Ideas to discuss with your doctor", (o.common_investigations||[]).slice(0,3)),
        bullet("Comfort-only tips (not a treatment plan)", (o.self_care||[]).slice(0,3)),
        bullet("Watch-outs", watch),
        bullet("Info your doctor may ask/check", infoGaps),
        o.final_reminder || "Please see a doctor for personalised advice."
      ].filter(Boolean);
      return parts.join("\n\n");
    }

    // New topic
    newBtn.addEventListener("click", () => {
      history = [];
      saveHistory();
      chatEl.innerHTML = "";
      typingEl.classList.add("hidden");
      inputEl.value = "";
      inputEl.focus();
    });

    // Enter to send, Shift+Enter for newline
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit(btn);
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = inputEl.value.trim();
      if (!question) return;
      addMsg("user", question);
      inputEl.value = "";
      btn.disabled = true; btn.textContent = "Thinking…";
      typingEl.classList.remove("hidden");

      try {
        const r = await fetch("/.netlify/functions/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, history })
        });
        const j = await r.json();
        if (!j.ok) throw j;

        const o = j.result || {};
        const stage = o.stage || (o.advice_text ? "advice" : "intake");

        if (stage === "advice") {
          const adviceText = formatAdvice(o);
          addMsg("assistant", adviceText);
        } else {
          // Intake: one concise question; ensure non-empty fallback
          let chatReply = (o.chat_reply || "").trim();
          if (!chatReply) chatReply = "Quick one: when did this start — suddenly or gradually?";
          addMsg("assistant", chatReply);
        }

        // Save short turn to history
        history.push({ role: "user", content: question });
        const assistantContent = (stage === "advice"
          ? (o.summary || o.chat_reply || "Advice provided.")
          : (o.chat_reply || "A follow-up question")).slice(0, 800);
        history.push({ role: "assistant", content: assistantContent });
        history = history.slice(-12);
        saveHistory();

      } catch (err) {
        const msg = err?.error?.message || err?.error || err?.message || "Something went wrong. Please try again.";
        alert(msg);
      } finally {
        btn.disabled = false; btn.textContent = "Send";
        typingEl.classList.add("hidden");
        inputEl.focus();
      }
    });
  </script>
</body>
</html>


