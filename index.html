<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doc Adams Q&A</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e8eef5; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 24px; }
    .card { background:#121924; border:1px solid #203042; border-radius: 14px; padding: 16px; margin: 12px 0; }
    h1 { font-size: 1.6rem; margin: 0 0 10px; }
    .disclaimer { font-size: .93rem; line-height:1.5; background:#0e1520; border:1px solid #27384e; padding:12px; border-radius:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    textarea { width:100%; min-height: 110px; resize: vertical; }
    input, textarea, button { background:#0d1420; color:#e8eef5; border:1px solid #2a3c52; border-radius:10px; padding:10px 12px; }
    button { cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .thumbs img { max-height: 72px; border-radius: 8px; border:1px solid #2a3c52; }
    .typing { display:none; align-items:center; gap:8px; font-size:.95rem; color:#a9bed6; }
    .dot { width:6px; height:6px; border-radius: 50%; background:#a9bed6; animation: blink 1.2s infinite ease-in-out; }
    .dot:nth-child(2){animation-delay:.2s} .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink { 0%,80%,100%{opacity:.2} 40%{opacity:1} }
    .err { color:#ff8c8c }
    .section h3 { margin:.2rem 0 .2rem; font-size:1rem; color:#b9d1ea }
    ul { margin:.2rem 0 .8rem 1.2rem; }
    a { color:#8fc5ff; }
    .refs a { display:block; overflow-wrap:anywhere; }
    .chat { white-space:pre-wrap }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Doc Adams Q&amp;A</h1>

    <div class="disclaimer card">
      <strong>Important:</strong> This AI was trained and instructed by Doc Adam to give <em>general education only</em>.
      It can be wrong. It’s <strong>not medical advice</strong>, not a diagnosis, and not a treatment plan. Don’t ignore
      or delay professional care because of something here. If you have concerning symptoms, <strong>see a doctor</strong>.
    </div>

    <div class="card">
      <label for="q"><strong>Your question</strong></label>
      <textarea id="q" placeholder="Describe your concern in 1–2 sentences…"></textarea>

      <div class="row" style="margin-top:8px">
        <input id="images" type="file" accept="image/*" multiple />
        <button id="askBtn">Ask</button>
        <button id="clearBtn" title="Clear conversation">Reset</button>
      </div>
      <div id="thumbs" class="thumbs row" style="margin-top:6px"></div>

      <div id="typing" class="typing" style="margin-top:10px">
        <span>Thinking</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <div id="error" class="err"></div>
    </div>

    <div id="chat" class="card chat"></div>
    <div id="result" class="card" style="display:none"></div>
  </div>

  <script>
    // --- simple client state ---
    const history = []; // keep last ~6 turns compatible with your function
    let imageDataUrls = [];

    const qEl = document.getElementById('q');
    const askBtn = document.getElementById('askBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileEl = document.getElementById('images');
    const thumbsEl = document.getElementById('thumbs');
    const typingEl = document.getElementById('typing');
    const errorEl = document.getElementById('error');
    const chatEl = document.getElementById('chat');
    const resultEl = document.getElementById('result');

    function showTyping(show){ typingEl.style.display = show ? 'flex' : 'none'; }
    function setError(msg){ errorEl.textContent = msg || ''; }

    function appendChat(role, text) {
      const who = role === 'user' ? 'You' : 'Assistant';
      const b = document.createElement('div');
      b.innerHTML = `<strong>${who}:</strong> ${escapeHtml(text)}`;
      chatEl.appendChild(b);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function escapeHtml(s){
      return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    // Handle image selection -> data URLs (max 3)
    fileEl.addEventListener('change', async (e) => {
      imageDataUrls = [];
      thumbsEl.innerHTML = '';
      const files = Array.from(e.target.files || []).slice(0,3);
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        // keep uploads small to avoid function limits
        const dataUrl = await fileToDataUrl(f, 1600, 1600, 0.85);
        imageDataUrls.push(dataUrl);
        const img = document.createElement('img');
        img.src = dataUrl;
        thumbsEl.appendChild(img);
      }
    });

    function fileToDataUrl(file, maxW, maxH, quality){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const {canvas, url} = downscale(img, maxW, maxH, quality);
            resolve(url);
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function downscale(img, maxW, maxH, q){
      const r = Math.min(1, maxW / img.width, maxH / img.height);
      const w = Math.round(img.width * r), h = Math.round(img.height * r);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      const url = canvas.toDataURL('image/jpeg', q ?? 0.9);
      return {canvas, url};
    }

    async function ask() {
      setError('');
      const question = (qEl.value || '').trim();
      if (question.length < 10) {
        setError('Please ask a longer question.');
        return;
      }
      askBtn.disabled = true;
      showTyping(true);

      appendChat('user', question);

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            question,
            history,
            images: imageDataUrls
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data.error || 'Request failed');
        }

        const out = data.result; // structured JSON
        const reply = out.chat_reply || '';
        appendChat('assistant', reply);

        // update short history (store text only)
        history.push({ role:'user', content: question });
        history.push({ role:'assistant', content: reply });
        while (history.length > 12) history.shift();

        // render sections for first answers
        renderStructured(out);
      } catch (err) {
        console.error(err);
        setError(err.message || 'Something went wrong.');
      } finally {
        showTyping(false);
        askBtn.disabled = false;
        qEl.value = '';
        fileEl.value = '';
        thumbsEl.innerHTML = '';
        imageDataUrls = [];
      }
    }

    function renderStructured(o){
      // If we only got a short follow-up, hide the big panel
      const isFollow = !(o.possible_causes && o.self_care);
      if (isFollow) { resultEl.style.display = 'none'; resultEl.innerHTML = ''; return; }

      const list = (arr) => arr && arr.length
        ? '<ul>' + arr.map(x => `<li>${escapeHtml(x)}</li>`).join('') + '</ul>'
        : '<ul><li>—</li></ul>';

      const refs = (o.references || []).map((r,i) => `<a href="${r}" target="_blank" rel="noopener">Reference ${i+1}</a>`).join('');

      resultEl.innerHTML = `
        <div class="section"><h3>Disclaimer</h3><div>${escapeHtml(o.disclaimer || '')}</div></div>
        <div class="section"><h3>Possible causes</h3>${list(o.possible_causes || [])}</div>
        <div class="section"><h3>Home care / self‑care</h3>${list(o.self_care || [])}</div>
        <div class="section"><h3>Possible investigations</h3>${list(o.investigations || [])}</div>
        <div class="section"><h3>Treatments a doctor might do</h3>${list(o.treatments || [])}</div>
        <div class="section"><h3>Red flags</h3>${list(o.red_flags || [])}</div>
        <div class="section"><h3>When to seek help</h3><div>${escapeHtml(o.when_to_seek_help || '')}</div></div>
        <div class="section refs"><h3>References</h3>${refs || '<div>—</div>'}</div>
        <div class="section"><h3>Follow‑up question for you</h3><div>${escapeHtml(o.ask_back || '')}</div></div>
      `;
      resultEl.style.display = 'block';
    }

    askBtn.addEventListener('click', ask);
    qEl.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) ask();
    });
    clearBtn.addEventListener('click', () => {
      history.length = 0;
      chatEl.innerHTML = '';
      resultEl.innerHTML = '';
      resultEl.style.display = 'none';
      setError('');
    });
  </script>
</body>
</html>
